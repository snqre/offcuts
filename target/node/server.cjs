"use strict";var me=Object.create;var P=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var de=Object.getOwnPropertyNames;var Re=Object.getPrototypeOf,Ee=Object.prototype.hasOwnProperty;var Ae=(e,i)=>{for(var n in i)P(e,n,{get:i[n],enumerable:!0})},V=(e,i,n,r)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of de(i))!Ee.call(e,t)&&t!==n&&P(e,t,{get:()=>i[t],enumerable:!(r=ce(i,t))||r.enumerable});return e};var h=(e,i,n)=>(n=e!=null?me(Re(e)):{},V(i||!e||!e.__esModule?P(n,"default",{value:e,enumerable:!0}):n,e)),fe=e=>V(P({},"__esModule",{value:!0}),e);var Ie={};Ae(Ie,{Server:()=>pe});module.exports=fe(Ie);var N=h(require("express"),1);var C=require("bcrypt"),F=require("bcrypt"),g=require("reliq"),B=64,le=0,Se=256;function _e(e=B){let i;return(0,g.require)(e>=le,"AUTH.ERR_ASSIGNED_SALT_CANNOT_BE_BELOW_THE_CONSTANT_MINIMUM"),(0,g.require)(e<=Se,"AUTH.ERR_ASSIGNED_SALT_CANNOT_BE_ABOVE_THE_CONSTANT_MAXIMUM"),{get:n,set:r,setByEncryption:t,decrypt:a};function n(...[]){return(0,g.require)(i!==void 0,"AUTH.ERR_UNASSIGNED_HASH"),i}function r(...[o]){(0,g.require)(o.trim().length!==0,"AUTH.ERR_INVALID_HASH"),i=o}async function t(...[o]){(0,g.require)(o.trim().length!==0,"AUTH.ERR_INVALID_PASSWORD"),i=await(0,C.hash)(o,e)}async function a(...[o]){return await(0,F.compare)(o,i)}}async function G(e,i=B){let n;return n=_e(i),await n.setByEncryption(e),{...n}}var O=require("zod"),b=O.z.object({username:O.z.string().min(1),hash:O.z.string().min(1)});var A=require("zod"),f=A.z.object({name:A.z.string().min(1).refine(e=>e.trim().length>0),price:A.z.number().min(0).finite(),stock:A.z.number().min(0).finite().int(),tags:A.z.array(A.z.string().min(1)),imageUrl:A.z.string().min(1).optional()});var w=require("zod");var x=w.z.object({product:f,amount:w.z.number().min(1).int()});var U=h(require("validator"),1),l=require("zod");var I=l.z.object({username:l.z.string().min(1),hash:l.z.string().min(1),orders:l.z.array(x),email:l.z.string().optional().refine(e=>e?U.default.isEmail(e):!0),phoneNumber:l.z.string().optional().refine(e=>e?U.default.isMobilePhone(e):!0),address:l.z.string().optional().refine(e=>e?e.trim().length>0:!0)});var y=require("zod");var De=y.z.object({admins:y.z.array(b),users:y.z.array(I),products:y.z.array(f)});var ge=require("reliq");var ye=require("reliq");var Te=require("reliq");var Pe=require("reliq");var he=require("reliq");var k=h(require("validator"),1);var _=require("reliq");function K(e){return(0,_.require)(e.username.trim().length!==0,"USER_DATA.ERR_INVALID_USERNAME"),(0,_.require)(e.hash.trim().length!==0,"USER_DATA.ERR_INVALID_HASH"),(0,_.require)(e.email?k.default.isEmail(e.email):!0,"USER_DATA.ERR_INVALID_EMAIL"),(0,_.require)(e.phoneNumber?k.default.isMobilePhone(e.phoneNumber):!0,"USER_DATA.ERR_INVALID_PHONE_NUMBER"),(0,_.require)(e.address?e.address.trim().length!==0:!0,"USER_DATA.ERR_INVALID_ADDRESS"),(0,_.require)(Oe(e),"USER_DATA.ERR_SCHEMA_VALIDATION_FAILED"),e}function Oe(e){return I.safeParse(e).success}var H=require("redis"),T=require("reliq");async function X(e,i,n){let r;return(0,T.require)(e.trim().length!==0,"REDIS_SOCKET_ADAPTOR.ERR_INVALID_HOST"),(0,T.require)(n>=0n,"REDIS_SOCKET_ADAPTOR.ERR_INVALID_PORT"),(0,T.require)(n<=9e4,"REDIS_SOCKET_ADAPTOR.ERR_INVALID_PORT"),(0,T.require)(i.trim().length!==0,"REDIS_SOCKET_ADAPTOR.ERR_INVALID_PASSWORD"),r=(0,H.createClient)({password:i,socket:{host:e,port:Number(n)}}),await r.connect(),r}var q=require("reliq");async function Z(e,i){return(0,q.require)(i.trim().length!==0,"REDIS.ERR_INVALID_KEY"),{get:n,set:r,disconnect:t};async function n(...[]){let o=await e.get(i);return o==null&&(o=JSON.stringify(a())),JSON.parse(o)}async function r(...[o]){let R=JSON.stringify(o);await e.set(i,R)}async function t(...[]){await e.quit()}function a(){return{admins:[],users:[],products:[]}}}var d=require("reliq");function W(e){return{products:i,setStock:n,increaseStock:r,decreaseStock:t,setPrice:a,increasePrice:o,decreasePrice:R,listProduct:S,delistProduct:D};async function i(u){let s=await e.get();if(u){let m=[],p=0n;for(;p<s.products.length;){let c=s.products[Number(p)];c.name===u&&m.push(c),p++}return m}return s.products}async function n(u,s){(0,d.require)(u.trim().length!==0,"STORE.ERR_INVALID_NAME"),(0,d.require)(s>=0n,"STORE.ERR_AMOUNT_BELOW_ZERO");let m=await e.get(),p=0n;for(;p<m.products.length;){let c=m.products[Number(p)];c.name===u&&(c.stock=Number(s)),p++}await e.set(m)}async function r(u,s){(0,d.require)(u.trim().length!==0,"STORE.ERR_INVALID_NAME"),(0,d.require)(s>=0n,"STORE.ERR_AMOUNT_BELOW_ZERO");let m=await e.get(),p=0n;for(;p<m.products.length;){let c=m.products[Number(p)];c.name===u&&(c.stock+=Number(s)),p++}await e.set(m)}async function t(u,s){(0,d.require)(u.trim().length!==0,"STORE.ERR_INVALID_NAME"),(0,d.require)(s>=0n,"STORE.ERR_AMOUNT_BELOW_ZERO");let m=await e.get(),p=0n;for(;p<m.products.length;){let c=m.products[Number(p)];c.name===u&&((0,d.require)(c.stock-Number(s)>0,"STORE.ERR_INSUFFICIENT_STOCK"),c.stock-=Number(s)),p++}await e.set(m)}async function a(u,s){(0,d.require)(u.trim().length!==0,"STORE.ERR_INVALID_NAME"),(0,d.require)(s>=0,"STORE.ERR_AMOUNT_BELOW_ZERO"),(0,d.require)(s<=Number.MAX_SAFE_INTEGER,"STORE.ERR_AMOUNT_ABOVE_MAX_SAFE_INTEGER");let m=await e.get(),p=0n;for(;p<m.products.length;){let c=m.products[Number(p)];c.name===u&&(c.stock=s),p++}await e.set(m)}async function o(u,s){(0,d.require)(u.trim().length!==0,"STORE.ERR_INVALID_NAME"),(0,d.require)(s>=0,"STORE.ERR_AMOUNT_BELOW_ZERO"),(0,d.require)(s<=Number.MAX_SAFE_INTEGER,"STORE.ERR_AMOUNT_ABOVE_MAX_SAFE_INTEGER");let m=await e.get(),p=0n;for(;p<m.products.length;){let c=m.products[Number(p)];c.name===u&&((0,d.require)(c.price+s<=Number.MAX_SAFE_INTEGER,"STORE.ERR_PRICE_ABOVE_MAX_SAFE_INTEGER"),c.price+=s),p++}await e.set(m)}async function R(u,s){(0,d.require)(u.trim().length!==0,"STORE.ERR_INVALID_NAME"),(0,d.require)(s>=0,"STORE.ERR_AMOUNT_BELOW_ZERO"),(0,d.require)(s<=Number.MAX_SAFE_INTEGER,"STORE.ERR_AMOUNT_ABOVE_MAX_SAFE_INTEGER");let m=await e.get(),p=0n;for(;p<m.products.length;){let c=m.products[Number(p)];c.name===u&&((0,d.require)(c.price-s>=0,"STORE.ERR_PRICE_BELOW_ZERO"),c.price-=s),p++}await e.set(m)}async function S(u){let s=await e.get();s.products.push(u),await e.set(s)}async function D(u){let s;typeof u=="string"?s=u:s=u.name;let m=await e.get(),p=0n;for(;p<m.products.length;)m.products[Number(p)].name===s&&m.products.splice(Number(p),1),p++}}var Ot=require("stripe");function Q(e){return{quantity:Number(e.amount),price_data:{currency:"gbp",unit_amount:e.product.price,product_data:{name:e.product.name,description:e.product.name}}}}var xt=require("stripe");var j=require("reliq");function Y(e){return{receive:i};async function i(r,t,a,o){let R=await e.checkout.sessions.create({payment_method_types:["card"],line_items:[...t.map(s=>Q(s))||[]],mode:"payment",success_url:r+"/",cancel_url:r+"/"}),S=R.url;(0,j.require)(S!==null,"STRIPE_PAYMENT_PROVIDER.ERR_MISSING_SESSION_URL");let D=R.id,u=setInterval(async()=>{let s=await e.checkout.sessions.retrieve(D),m=s.payment_status==="paid"||s.status==="complete";if(s.status==="expired"){clearInterval(u),o(s);return}else if(m){clearInterval(u),a(s);return}},n(9));return setTimeout(async()=>{clearInterval(u);let s=await e.checkout.sessions.retrieve(D);o(s)},n(3600)),S}function n(r){return r*1e3}}var z=h(require("stripe"),1),J=require("reliq");function $(e){return(0,J.require)(e.trim().length!==0,"STRIPE_SOCKET_ADAPTOR.ERR_INVALID_API_KEY"),new z.default(e)}var ee=require("express");var Zt=require("zod");function te(e,i){return(0,ee.Router)().post("/checkout",async(n,r)=>{try{let{orders:t}=n.body;if(t.length===0){r.send({message:"NO_ORDERS"});return}t.forEach(u=>{u.product.price*=100});let o=`http://${n.headers.host}`,R=$(e),D=await Y(R).receive(o,t,u=>{console.log("Purchase successful"),t.forEach(async s=>{await i.decreaseStock(s.product.name,BigInt(s.amount))})},u=>{console.log("Purchase expired.")});r.send({url:D});return}catch(t){r.send({e:t});return}})}var re=require("express"),L=require("reliq");function oe(e,i){return(0,L.require)(e.trim().length!==0,"REACT_ROUTER.ERR_INVALID_ROUTE"),(0,L.require)(e.startsWith("/"),"REACT_ROUTER.ERR_INVALID_ROUTE"),(0,re.Router)().get(e,(n,r)=>r.sendFile(i))}var ne=require("express");var E=require("zod"),$t=require("reliq");function ie(e){return(0,ne.Router)().get("/store/products",async(n,r)=>{try{r.send({products:await e.products()});return}catch(t){console.error(t),r.send({e:t});return}}).get("/store/products-by-name",async(n,r)=>{try{let{name:t}=n.body;if(!(t!=null&&typeof t=="string")){r.send({message:"STORE_ROUTER.ERR_INVALID_REQUEST"});return}r.send({products:await e.products(t)});return}catch(t){console.error(t),r.send({e:t});return}}).post("/store/set-stock",async(n,r)=>{try{let t=E.z.object({password:E.z.string().refine(R=>i(R)),name:E.z.string(),amount:E.z.number()}).parse(n.body),{name:a,amount:o}=t;await e.setStock(a,BigInt(o)),r.send({message:"OK"});return}catch(t){console.error(t),r.send({e:t});return}}).post("/store/increase-stock",async(n,r)=>{try{let t=E.z.object({password:E.z.string().refine(R=>i(R)),name:E.z.string(),amount:E.z.number()}).parse(n.body),{name:a,amount:o}=t;await e.increaseStock(a,BigInt(o)),r.send({message:"OK"});return}catch(t){console.error(t),r.send({e:t});return}}).post("/store/decrease-stock",async(n,r)=>{try{let{password:t,name:a,amount:o}=n.body;if(!(t!=null&&typeof t=="string"&&i(t)&&a!==null&&a!==void 0&&typeof a=="string"&&o!==null&&o!==void 0&&typeof o=="number"&&o>=0&&o<=Number.MAX_SAFE_INTEGER&&Number.isSafeInteger(o))){r.send({message:"STORE_ROUTER.ERR_INVALID_REQUEST"});return}await e.decreaseStock(a,BigInt(o)),r.send({message:"OK"});return}catch(t){console.error(t),r.send({e:t});return}}).post("/store/set-price",async(n,r)=>{try{let{password:t,name:a,amount:o}=n.body;if(!(t!=null&&typeof t=="string"&&i(t)&&a!==null&&a!==void 0&&typeof a=="string"&&o!==null&&o!==void 0&&typeof o=="number"&&o>=0&&o<=Number.MAX_SAFE_INTEGER&&Number.isSafeInteger(o))){r.send({message:"STORE_ROUTER.ERR_INVALID_REQUEST"});return}await e.setPrice(a,o),r.send({message:"OK"});return}catch(t){console.error(t),r.send({e:t});return}}).post("/store/increase-price",async(n,r)=>{try{let{password:t,name:a,amount:o}=n.body;if(!(t!=null&&typeof t=="string"&&i(t)&&a!==null&&a!==void 0&&typeof a=="string"&&o!==null&&o!==void 0&&typeof o=="number"&&o>=0&&o<=Number.MAX_SAFE_INTEGER&&Number.isSafeInteger(o))){r.send({message:"STORE_ROUTER.ERR_INVALID_REQUEST"});return}await e.increasePrice(a,o),r.send({message:"OK"});return}catch(t){console.error(t),r.send({e:t});return}}).post("/store/decrease-price",async(n,r)=>{try{let{password:t,name:a,amount:o}=n.body;if(!(t!=null&&typeof t=="string"&&i(t)&&a!==null&&a!==void 0&&typeof a=="string"&&o!==null&&o!==void 0&&typeof o=="number"&&o>=0&&o<=Number.MAX_SAFE_INTEGER&&Number.isSafeInteger(o))){r.send({message:"STORE_ROUTER.ERR_INVALID_REQUEST"});return}await e.decreasePrice(a,o),r.send({message:"OK"});return}catch(t){console.error(t),r.send({e:t});return}}).post("/store/list-product",async(n,r)=>{try{let{password:t,product:a}=n.body;if(!(t!=null&&typeof t=="string"&&i(t)&&f.safeParse(a).success)){r.send({message:"STORE_ROUTER.ERR_INVALID_REQUEST"});return}await e.listProduct(a),r.send({message:"OK"});return}catch(t){console.error(t),r.send({e:t});return}}).post("/store/delist-product-by-name",async(n,r)=>{try{let{password:t,name:a}=n.body;if(!(t!=null&&typeof t=="string"&&i(t)&&a!==null&&a!==void 0&&typeof a=="string")){r.send({message:"STORE_ROUTER.ERR_INVALID_REQUEST"});return}await e.delistProduct(a),r.send({message:"OK"});return}catch(t){console.error(t),r.send({e:t});return}}).post("/store/delist-product-by-product",async(n,r)=>{try{let{password:t,product:a}=n.body;if(!(t!=null&&typeof t=="string"&&i(t)&&f.safeParse(a).success)){r.send({message:"STORE_ROUTER.ERR_INVALID_REQUEST"});return}await e.delistProduct(a),r.send({message:"OK"});return}catch(t){console.error(t),r.send({e:t});return}});function i(n){let r=process.env?.ADMIN_PASSWORD;return r===void 0||r.trim().length===0?!1:r===n}}var ae=require("express");var se=require("reliq");function ue(e){return(0,ae.Router)().post("/sign-up",async(i,n)=>{try{let{username:r,password:t}=i.body,a=await e.get(),o=a.users.filter(S=>S.username===r).length!==0;(0,se.require)(o===!1,"USER_ROUTER.USERNAME_ALREADY_TAKEN"),a.users.push(K({username:r,hash:(await G(t)).get(),orders:[]})),await e.set(a),n.send({message:"OK"});return}catch(r){n.send({e:r});return}}).post("/sign-in",async(i,n)=>{})}var M=require("reliq"),v=require("path");function pe(){return{run:e};async function e(...[]){let i=process.env?.REDIS_INT_KEY;(0,M.require)(i!==void 0,"SERVER.ERR_REDIS_INT_KEY_REQUIRED");let n=await X("redis-15540.c85.us-east-1-2.ec2.redns.redis-cloud.com",i,15540n),r=await Z(n,"*"),t=W(r),a=process.env?.STRIPE_INT_TEST_KEY;(0,M.require)(a!==void 0,"SERVER.ERR_STRIPE_INT_TEST_KEY_REQUIRED");let o=3e3,R=(0,N.default)().use(N.default.static((0,v.join)(__dirname,"web"))).use(N.default.json()).use(oe("/",(0,v.join)(__dirname,"web/app.html"))).use(ie(t)).use(te(a,t)).use(ue(r)).listen(o);console.log("SERVER.RUNNING",__dirname,o)}}pe().run();0&&(module.exports={Server});
